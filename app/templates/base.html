<!--Extends from bootstrap, which provides blocks for 'title', 'navigation',
   and 'content'. We implement each block below.-->
{% extends 'bootstrap/base.html' %}

{% block title %}
{% if title %}{{ title }} - Microblog-Py{% else %}{{ _('Welcome to Microblog-Py') }}{% endif %}
{% endblock %}

{% block navbar %}
<nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
        data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="{{ url_for('main.index') }}">Microblog-Py</a>
    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="{{ url_for('main.index') }}">{{ _('Home') }}</a></li>
        <li><a href="{{ url_for('main.explore') }}">{{ _('Explore') }}</a></li>
      </ul>
      <!--'g' is available to all templates.-->
      {% if g.search_form %}
      <!--Need to specify action because this appears in all pages, need to tell them where to go.-->
      <form class="navbar-form navbar-left" method="get" 
            action="{{ url_for('main.search') }}">
        <div class="form-group">
          {{ g.search_form.q(size=20, class='form-control',
                                  placeholder=g.search_form.q.label.text) }}
        </div>
      </form>
      {% endif %}
      <ul class="nav navbar-nav navbar-right">
        {% if current_user.is_anonymous %}
        <li><a href="{{ url_for('auth.login') }}">{{ _('Login') }}</a></li>
        {% else %}
        <li>
          <a href="{{ url_for('main.messages') }}">
            {{ _('Messages') }}
            <!--Bootstrap badge for notifcation in nav bar.-->
            {% set new_messages = current_user.new_messages() %}
            {% if new_messages %}
            <!--Always render badge, but only show if user has messages.-->
            <span id="message_count" class="badge"
                  style="visibility: {% if new_messages %}visible
                                     {% else %}hidden {% endif %};">
                                     {{ new_messages }}
            </span>
            {% endif %}
          </a>
        </li>
        <li><a href="{{ url_for('main.user', username=current_user.username) }}">{{ _('Profile') }}</a></li>
        <li><a href="{{ url_for('auth.logout') }}">{{ _('Logout') }}</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="container">
  {% with messages = get_flashed_messages() %}
  {% if messages %}
  {% for message in messages %}
  <div class="alert alert-info" role="alert">{{ message }}</div>
  {% endfor %}
  {% endif %}
  {% endwith %}

  <!--application content needs to be provided in the app_content block-->
  {% block app_content %}{% endblock %}
</div>
<div class="container">
  {% if current_user.is_authenticated %}
    {% with tasks = current_user.get_tasks_in_progress() %}
      {% if tasks %}
        {% for task in tasks %}
          <div class="alert alert-success" role="alert">
            {{ task.description }}
            <span id="{{ task.id }}-progress">{{ task.get_progress() }}</span>%
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  {% endif %}
{% endblock %}


<!--Include Moment here, so everythin has access. This include function
generates the script tag to hold Moment.js-->
{% block scripts %}
  <!--super preserves the content from the base template for the scripts
      block.-->
  {{ super() }}
  {{ moment.include_moment() }}
  <!--Use the locale variable to configue moment for localization.-->
  {{ moment.lang(g.locale) }}
  <!--The translation logic script. Takes an input and output DOM nodes, source and destination languages, issues Ajax request to server, and replace Translate link with translated text when server responds.-->
    <script>
      function translate(sourceElem, destElem, sourceLang, destLang) {
        $(destElem).html('<img src="{{ url_for('static', filename='loading.gif') }}">');
        $.post('/translate', {
          text: $(sourceElem).text(),
          source_language: sourceLang,
          dest_language: destLang
        }).done(function (response) {
          console.log("sucess", destElem, response['text'])
          $(destElem).text("Fake Text")
        }).fail(function () {
          $(destElem).text("{{ _('Error: Could not contact server.') }}");
        });
      }
      /* Define function in $() to run when page loads.*/
      $(function() {
        /* jQuery syntax to find all elements with class name of user_popup, which in our case is all user links. We attach the hover event to all these links.*/
        var timer = null;
        var xhr = null;
        $('.user_popup').hover(
          // browser auto dispatches hover events when mouse enters.
          function(event) {
            // mouse in event handler
            var elem = $(event.currentTarget);
            // Prevent popups from immediately showing
            timer = setTimeout(function() {
              timer = null;
              /* Use jQuery to send Ajax to server to get user popup page and
              obtain the username based on the context of the hover event.
              */
              xhr = $.ajax(
                    '/user/' + elem.first().text().trim() + '/popup').done(
                      function(data) {
                        xhr = null;
                        // Bootrstrap popover()
                        elem.popover({
                          trigger: 'manual',
                          html: true,
                          animation: false,
                          container: elem,
                          content: data
                        }).popover('show');
                        /* Flask-Moment docs say when new elements are added
                        via Ajax, call this function to appropriately render
                        */
                        flask_moment_render_all();
                      }
                    );
            }, 1000);
          },
          // Good UX here. Reset timer and clear Ajax request if mouse exits.
          function(event) {
            // mouse out event handler
            var elem = $(event.currentTarget);
            if (timer) {
              clearTimeout(timer);
              timer = null;
            }
            else if (xhr) {
              xhr.abort();
              xhr = null;
            }
            else {
              // destroy popup
              elem.popover('destroy');
            }
          }
        )
      });
      /* JS to update badge number */
      function set_message_count(n) {
        // jQuery to find badge.
        $('#message_count').text(n);
        // If count is zero, hide.
        $('#message_count').css('visibility', n ? 'visible': 'hidden');
      }
      /* Implement notificaton polling here so all pages can use it. */
      {% if current_user.is_authenticated %}
        $(function () {
          /* On page load, set a timer that regulates polling for notifs. 
          setInterval is like setTimeout, but keeps calling callback function
          at interval.*/
          var since = 0;
          setInterval(function () {
            $.ajax('{{ url_for('main.notifications') }}?since=' + since).done(
              function (notifications) {
                for (var i = 0; i < notifications.length; i++) {
                  switch (notifications[i].name) {
                    case 'unread_message_count':
                      set_message_count(notifications[i].data);
                      break;
                    case 'task_progress':
                      set_task_progress(
                        notifications[i].data.task_id,
                        notifications[i].data.progress);
                      break;
                  }
                  since = notifications[i].timestamp;
                }
              }
            );
            // Updates notif badge 6 times per minute.
          }, 10000);
        });
        // Also only show export progress if logged in
        function set_task_progress(task_id, progress) {
            $('#' + task_id + '-progress').text(progress);
          }
        {% endif %}
    </script>
{% endblock %}
